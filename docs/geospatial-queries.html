<!DOCTYPE html SYSTEM "about:legacy-compat">
<html lang="en-US" data-preset="contrast" data-primary-color="#307FFF"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="UTF-8"><meta name="robots" content="noindex"><meta name="built-on" content="2025-07-13T01:56:46.242241062"><title>Geospatial Queries | Google App Engine Java Documentation</title><script type="application/json" id="virtual-toc-data">[{"id":"adding-a-geopt-to-an-entity","level":0,"title":"Adding a GeoPt to an entity","anchor":"#adding-a-geopt-to-an-entity"},{"id":"geospatial-queries","level":0,"title":"Geospatial queries","anchor":"#geospatial-queries"},{"id":"building-an-index-file","level":0,"title":"Building an Index file","anchor":"#building-an-index-file"},{"id":"known-issues","level":0,"title":"Known issues","anchor":"#known-issues"}]</script><script type="application/json" id="topic-shortcuts"></script><link href="https://resources.jetbrains.com/writerside/apidoc/6.22.0-b776/app.css" rel="stylesheet"><meta name="msapplication-TileColor" content="#000000"><link rel="apple-touch-icon" sizes="180x180" href="https://jetbrains.com/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="https://jetbrains.com/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="https://jetbrains.com/favicon-16x16.png"><meta name="msapplication-TileImage" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-144x144.png"><meta name="msapplication-square70x70logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-70x70.png"><meta name="msapplication-square150x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-150x150.png"><meta name="msapplication-wide310x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x150.png"><meta name="msapplication-square310x310logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x310.png"><meta name="image" content=""><!-- Open Graph --><meta property="og:title" content="Geospatial Queries | Google App Engine Java Documentation"><meta property="og:description" content=""><meta property="og:image" content=""><meta property="og:site_name" content="Google App Engine Java Documentation Help"><meta property="og:type" content="website"><meta property="og:locale" content="en_US"><meta property="og:url" content="writerside-documentation/geospatial-queries.html"><!-- End Open Graph --><!-- Twitter Card --><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content=""><meta name="twitter:title" content="Geospatial Queries | Google App Engine Java Documentation"><meta name="twitter:description" content=""><meta name="twitter:creator" content=""><meta name="twitter:image:src" content=""><!-- End Twitter Card --><!-- Schema.org WebPage --><script type="application/ld+json">{
    "@context": "http://schema.org",
    "@type": "WebPage",
    "@id": "writerside-documentation/geospatial-queries.html#webpage",
    "url": "writerside-documentation/geospatial-queries.html",
    "name": "Geospatial Queries | Google App Engine Java Documentation",
    "description": "",
    "image": "",
    "inLanguage":"en-US"
}</script><!-- End Schema.org --><!-- Schema.org WebSite --><script type="application/ld+json">{
    "@type": "WebSite",
    "@id": "writerside-documentation/#website",
    "url": "writerside-documentation/",
    "name": "Google App Engine Java Documentation Help"
}</script><!-- End Schema.org --></head><body data-id="Geospatial-Queries" data-main-title="Geospatial Queries" data-article-props="{&quot;seeAlsoStyle&quot;:&quot;links&quot;}" data-template="article" data-breadcrumbs="Guides.md|Guides///Storing-Data.md|Storing Data///Google-Cloud-Datastore.md|Google Cloud Datastore"><div class="wrapper"><main class="panel _main"><header class="panel__header"><div class="container"><h3>Google App Engine Java Documentation  Help</h3><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 data-toc="Geospatial-Queries" id="Geospatial-Queries.md">Geospatial Queries</h1><p id="z4tv1mp_3">This page describes how to use geospatial queries in Datastore. A geospatial query allows you to retrieve entities containing a <code class="code" id="z4tv1mp_11">GeoPt</code> property whose latitude, longitude coordinates lie within a given geographic region.</p><p id="z4tv1mp_4"><span class="control" id="z4tv1mp_12">Alpha</span></p><p id="z4tv1mp_5">This is an Alpha release of Geospatial search for datastore. It is not covered by any SLA or deprecation policy and may be subject to backward-incompatible changes. It is not recommended for production use. Access to this feature is by invitation only.</p><ol class="list _decimal" id="z4tv1mp_6" type="1"><li class="list__item" id="z4tv1mp_13"><p id="z4tv1mp_17"><span id="z4tv1mp_18">Adding a GeoPt to an entity</span></p></li><li class="list__item" id="z4tv1mp_14"><p id="z4tv1mp_19"><span id="z4tv1mp_20">Geospatial queries</span></p></li><li class="list__item" id="z4tv1mp_15"><p id="z4tv1mp_21"><span id="z4tv1mp_22">Building an Index file</span></p></li><li class="list__item" id="z4tv1mp_16"><p id="z4tv1mp_23"><span id="z4tv1mp_24">Known issues</span></p></li></ol><section class="chapter"><h2 id="adding-a-geopt-to-an-entity" data-toc="adding-a-geopt-to-an-entity">Adding a GeoPt to an entity</h2><p id="z4tv1mp_25">To add a <code class="code" id="z4tv1mp_27">GeoPt</code> property to an <a href="https://web.archive.org/web/20160424225630/https://cloud.google.com/appengine/docs/java/datastore/entities#Java_Creating_an_entity" id="z4tv1mp_28" data-external="true" rel="noopener noreferrer" target="_blank">entity</a>, use the <a href="https://web.archive.org/web/20160424225630/https://cloud.google.com/appengine/docs/java/javadoc/com/google/appengine/api/datastore/GeoPt" id="z4tv1mp_29" data-external="true" rel="noopener noreferrer" target="_blank">GeoPt</a> class, specifying latitude and longitude:</p><div class="code-block" data-lang="none">
Entity station = new Entity(&quot;GasStation&quot;);
station.setProperty(&quot;brand&quot;, &quot;Ocean Ave Shell&quot;);
station.setProperty(&quot;location&quot;, new GeoPt(37.7913156f,-122.3926051f));
ds.put(station);
</div></section><section class="chapter"><h2 id="geospatial-queries" data-toc="geospatial-queries">Geospatial queries</h2><p id="z4tv1mp_30">Use the datastore query filter <a href="https://web.archive.org/web/20160424225630/https://cloud.google.com/appengine/docs/java/javadoc/com/google/appengine/api/datastore/Query.StContainsFilter" id="z4tv1mp_36" data-external="true" rel="noopener noreferrer" target="_blank">StContainsFilter</a> to test if a <code class="code" id="z4tv1mp_37">GeoPt</code> is contained in a given <a href="https://web.archive.org/web/20160424225630/https://cloud.google.com/appengine/docs/java/javadoc/com/google/appengine/api/datastore/Query.GeoRegion" id="z4tv1mp_38" data-external="true" rel="noopener noreferrer" target="_blank">GeoRegion</a>, for example:</p><div class="code-block" data-lang="none">
// Testing for containment within a circle
GeoPt center = new GeoPt(latitude, longitude);
double radius = valueInMeters;
Filter f = new StContainsFilter(&quot;location&quot;, new Circle(center, radius));
Query q = new Query(&quot;Kind&quot;).setFilter(f);

// Testing for containment within a rectangle
GeoPt southwest = ...
GeoPt northeast = ...
Filter f = new StContainsFilter(&quot;location&quot;, new Rectangle(southwest, northeast));
Query q = new Query(&quot;Kind&quot;).setFilter(f);
</div><p id="z4tv1mp_32">You can combine geospatial containment terms with equality tests on any type of property:</p><div class="code-block" data-lang="none">
Filter f = CompositeFilter.and(
    new StContainsFilter(&quot;location&quot;, new Circle(center, radius)),
    new FilterPredicate(&quot;brand&quot;, FilterOperator.EQUAL, value));
</div><p id="z4tv1mp_34">Geospatial queries must follow these rules:</p><ul class="list _bullet" id="z4tv1mp_35"><li class="list__item" id="z4tv1mp_39"><p id="z4tv1mp_42">The query must include at least one containment term.</p></li><li class="list__item" id="z4tv1mp_40"><p id="z4tv1mp_43">The query may contain any number of non-geospatial terms, but these other terms may only test for EQUAL (not &quot;less than&quot;, &quot;greater than&quot;, etc.).</p></li><li class="list__item" id="z4tv1mp_41"><p id="z4tv1mp_44">The query cannot use an <a href="https://web.archive.org/web/20160424225630/https://cloud.google.com/appengine/docs/java/datastore/queries#Java_Ancestor_queries" id="z4tv1mp_45" data-external="true" rel="noopener noreferrer" target="_blank">ancestor filter</a>.</p></li></ul></section><section class="chapter"><h2 id="building-an-index-file" data-toc="building-an-index-file">Building an Index file</h2><p id="z4tv1mp_46">As with other Datastore queries, the recommended development workflow is to rely on the automatic index configuration provided by the dev appserver. You implement queries in your code, and then execute all of them while running tests on the dev appserver. This causes the dev appserver to write an index configuration file defining the necessary indexes.</p><p id="z4tv1mp_47">The form of an index definition that supports geospatial queries is a bit different from traditional composite indexes. For example:</p><div class="code-block" data-lang="none">
&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
&lt;datastore-indexes&gt;
  &lt;datastore-index kind=&quot;GasStation&quot;&gt;
    &lt;property name=&quot;brand&quot; /&gt;
    &lt;property name=&quot;location&quot; mode=&quot;geospatial&quot; /&gt;
  &lt;/datastore-index&gt;
&lt;/datastore-indexes&gt;
</div><p id="z4tv1mp_49">If you build your own search index files to handle geospatial searches, be sure to follow these rules:</p><ul class="list _bullet" id="z4tv1mp_50"><li class="list__item" id="z4tv1mp_53"><p id="z4tv1mp_57">Add the <code class="code" id="z4tv1mp_58">mode=&quot;geospatial&quot;</code> attribute to properties that appear in geo-containment query terms.</p></li><li class="list__item" id="z4tv1mp_54"><p id="z4tv1mp_59">Do not assign the <code class="code" id="z4tv1mp_60">direction</code> attribute to <span class="emphasis" id="z4tv1mp_61">any</span> property in an index designed to handle geospatial searches.</p></li><li class="list__item" id="z4tv1mp_55"><p id="z4tv1mp_62">Non-geospatial properties should be listed first, and each of the two groups of properties should appear in increasing alpha order by property name.</p></li><li class="list__item" id="z4tv1mp_56"><p id="z4tv1mp_63">Do not assign the <code class="code" id="z4tv1mp_64">ancestor</code> attribute to an index that contains a <code class="code" id="z4tv1mp_65">mode=&quot;geospatial&quot;</code> property.</p></li></ul><p id="z4tv1mp_51">One index configuration file can include multiple indexes of any kind.</p><p id="z4tv1mp_52">Recall that &quot;ordinary&quot; (non-geospatial) queries require that an index exists that contains all the properties in the query and no others. This constraint is relaxed for geospatial queries. An index with more than one <code class="code" id="z4tv1mp_66">mode=&quot;geospatial&quot;</code> property can be used to perform a geospatial query that only uses a subset of the geospatial properties in that index. If a geospatial query includes other non-geospatial properties, the index must also contain those non-geo properties and no others, as the case with non-geospatial queries.</p></section><section class="chapter"><h2 id="known-issues" data-toc="known-issues">Known issues</h2><p id="z4tv1mp_67">This is an alpha release of geospatial search. It has some limitations that will be removed in future releases:</p><ul class="list _bullet" id="z4tv1mp_68"><li class="list__item" id="z4tv1mp_69"><p id="z4tv1mp_74">Geospatial search is only available in the Java runtime, Python support is coming soon.</p></li><li class="list__item" id="z4tv1mp_70"><p id="z4tv1mp_75">Geospatial search is only accessible using App Engine's Datastore API, there is no GQL support at this time.</p></li><li class="list__item" id="z4tv1mp_71"><p id="z4tv1mp_76"><a href="https://web.archive.org/web/20160424225630/https://cloud.google.com/appengine/docs/java/datastore/queries#Java_Query_cursors" id="z4tv1mp_77" data-external="true" rel="noopener noreferrer" target="_blank">Cursors</a> will not appear in results from geospatial queries. Calls to <code class="code" id="z4tv1mp_78">QueryResultIterator.getCusor()</code> return <code class="code" id="z4tv1mp_79">NULL</code>.</p></li><li class="list__item" id="z4tv1mp_72"><p id="z4tv1mp_80">In the Google Cloud Platform Console, you can <a href="https://web.archive.org/web/20160424225630/https://console.cloud.google.com/project/_/datastore/indexes" id="z4tv1mp_81" data-external="true" rel="noopener noreferrer" target="_blank">view indexes that support geospatial queries</a>. However, property names with the <code class="code" id="z4tv1mp_82">mode=&quot;geospatial&quot;</code> attribute are not labeled as such, and they are (incorrectly) assigned a default descending sort direction.</p></li><li class="list__item" id="z4tv1mp_73"><p id="z4tv1mp_83">It is not possible to run a geospatial query from the Google Cloud Platform Console.</p></li></ul></section><div class="last-modified">10 April 2024</div><div data-feedback-placeholder="true"></div><div class="navigation-links _bottom"><a href="datastore-queries.html" class="navigation-links__prev">Datastore Queries</a><a href="projection-queries.html" class="navigation-links__next">Projection Queries</a></div></article><div id="disqus_thread"></div></div></section></main></div><script src="https://resources.jetbrains.com/writerside/apidoc/6.22.0-b776/app.js"></script></body></html>