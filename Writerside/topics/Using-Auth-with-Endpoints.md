# Using Auth with Endpoints

  

You must specify Endpoints auth following the directions provided on this page. Note that you cannot set a user login requirement following the instructions provided under [Security and Authentication](https://web.archive.org/web/20160424225802/https://cloud.google.com/appengine/docs/java/config/webxml#Security_and_Authentication) to configure the `web.xml` file, because this will result in a deployment failure.

For information on authentication from the perspective of keeping the backend secure, see the blog post [Verifying Back-End Calls from Android Apps](https://web.archive.org/web/20160424225802/https://android-developers.blogspot.com/2013/01/verifying-back-end-calls-from-android.html).

## Requirements

The instructions on this page assume that you have a Google Cloud Platform Console project for your application. If you don't have one yet, here's how to create one:

1.  In the Cloud Platform Console, go to the <a href="https://web.archive.org/web/20160424225802/https://console.cloud.google.com/project" target="console" data-track-type="commonIncludes" data-track-name="consoleLink" data-track-metadata-end-goal="createProject">Projects page</a>.
2.  Select a project, or click **Create Project** to create a new Cloud Platform Console project.
3.  In the dialog, name your project. Make a note of your generated project ID.
4.  Click **Create** to create a new project.

## Adding authorization to an API backend

If you wish to restrict all or part of your API to only authorized apps, you must:

1.  [Specify the client IDs](#Specifying_authorized_clients_in_the_API_backend) (`clientIds`) of apps authorized to make requests to your API backend.
2.  [Add a User parameter](#Adding_a_user_parameter_to_methods_for_auth) to all exposed methods to be protected by authorization.
3.  Generate the [client library](https://web.archive.org/web/20160424225802/https://cloud.google.com/appengine/docs/java/endpoints/gen_clients) again for any Android clients
4.  [Redeploy](https://web.archive.org/web/20160424225802/https://cloud.google.com/appengine/docs/java/endpoints/test_deploy) your backend API.
5.  If you have an Android client, update the regenerated jar file to your Android project.
6.  If you have an iOS client, regenerate the Objective-C library.

### Specifying authorized clients in the API backend

You must specify which clients are allowed to access the API backend by means of a whitelist of *client IDs*. A client ID is generated by the [Google Cloud Platform Console](https://web.archive.org/web/20160424225802/https://console.cloud.google.com/) from a client secret, such as the SHA1 fingerprint of a key used to secure an Android app, or from the Bundle ID/Apple Store ID pair for an iOS app, as described in [Creating OAuth 2.0 Client IDs](#Creating_OAuth_20_client_IDs). At runtime, a client app is granted the authorization token it needs to send requests to the API backend if its client secret matches one contained in a client ID within the API backend's client ID whitelist.

To specify which clients can be authenticated by your API backend:

1.  Get a complete list of the [client IDs](https://web.archive.org/web/20160424225802/https://support.google.com/cloud/answer/6158849) of the clients that you want to grant access to. This list is a list of OAuth 2.0 client IDs obtained for your project following the instructions provided below under [Creating OAuth 2.0 Client IDs](#Creating_OAuth_20_client_IDs).
2.  In the `clientIds` attribute of the [@Api](https://web.archive.org/web/20160424225802/https://cloud.google.com/appengine/docs/java/endpoints/annotations#API-Scoped-Annotations) or [@ApiMethod](https://web.archive.org/web/20160424225802/https://cloud.google.com/appengine/docs/java/endpoints/annotations#Method-Scoped-Annotations) annotations for your API, supply the list of client IDs that you want to authenticate:
    -   For an iOS app, supply its iOS client ID in the `clientIds` whitelist.
    -   For a javascript app, supply its web client ID in the `clientIds` whitelist.
    -   For an Android app, you must supply both its Android client ID and a web client ID in `clientIds` whitelist. (You must add that same web client ID to the `audiences` list as shown next.)
3.  If you have an Android client, you must also supply the `audiences` attribute for the @Api annotation, set to the web client ID mentioned in the preceding step. The same web client ID must be in both `clientIds` and `audiences`.

The following sample snippet shows how to supply client IDs for a javascript client, for an iOS client, and an Android client:

```
@Api(
    name = "tictactoe",
    version = "v1",
    scopes = {Constants.EMAIL_SCOPE},
    clientIds = {Constants.WEB_CLIENT_ID, Constants.ANDROID_CLIENT_ID, Constants.IOS_CLIENT_ID},
    audiences = {Constants.ANDROID_AUDIENCE}
)

public class Constants {
  public static final String WEB_CLIENT_ID = "1-web-apps.apps.googleusercontent.com";
  public static final String ANDROID_CLIENT_ID = "2-android-apps.googleusercontent.com";
  public static final String IOS_CLIENT_ID = "3-ios-apps.googleusercontent.com";
  public static final String ANDROID_AUDIENCE = WEB_CLIENT_ID;

  public static final String EMAIL_SCOPE = "https://www.googleapis.com/auth/userinfo.email";
}
```

In the snippet, note the use of a class to map constants to the actual client ID values so you need only make changes in one place whenever you change the client IDs. Notice also that `audiences` is set to the web client ID value.

**Note:** Because the authorized `clientIds` must be specified at build time, you must rebuild and redeploy your API backend after adding or changing any client IDs in `clientIds` or `audiences`. (You must also update the regenerated jar file for your Android project for an Android client and regenerate the Objective-C library for iOS clients.)

### Adding a user parameter to methods for auth

When you declare a parameter of type `User` in your API method, the API backend framework automatically authenticates the user and enforces the authorized `clientIds` whitelist, ultimately by supplying the valid `User` or not. If the request from the app has a valid auth token or is in the list of authorized `clientIDs`, the framework supplies a valid `User` to the parameter. If the incoming request does not have a valid auth token or if the client is not on the `clientIDs` whitelist, the framework sets the `User` parameter to null. Your own code must handle the null case and the non-null case, as shown below.

To add a `User` param to your method:

1.  Import the App Engine User API in your API class:

    ```
    import com.google.appengine.api.users.User;
    ```

2.  Add a parameter of type `User` to each class method you wish to require authorization for, as shown in the following snippet:

    ```
    /**
     * Provides the ability to insert a new Score entity.
     */
    @ApiMethod(name = "scores.insert")
    public Score insert(Score score, User user) throws OAuthRequestException, IOException {
      ...
    }
    ```

If an incoming client request has no authorization token or an invalid one, `user` is `null`. In your code, you need to check whether `user` is `null` and do ONE of the following, depending on the condition:

-   If the user is non-null, perform the authorized action.
-   If the user is null, throw an `OAuthRequestException`.
-   Alternatively, if the user is null, perform some action for an unauthorized client access if some sort of unauthorized access is desired.

## Providing authorization from clients

If your API backend requires authorization, you need to also support this authorization in your Android, iOS, or JavaScript client. Instructions for this vary slightly by client type, so more information is provided in these client-specific pages:

-   [Making Authenticated Calls from an Android Client](https://web.archive.org/web/20160424225802/https://cloud.google.com/appengine/docs/java/endpoints/consume_android#making_authenticated_calls)
-   [Using Endpoints in an iOS Client](https://web.archive.org/web/20160424225802/https://cloud.google.com/appengine/docs/java/endpoints/consume_ios)
-   [Making Authenticated Calls from a JavaScript Client](https://web.archive.org/web/20160424225802/https://cloud.google.com/appengine/docs/java/endpoints/consume_js#adding_authentication_support_with_oauth_20)

## Creating OAuth 2.0 client IDs

If you wish to require authorization to access your API backend, you must obtain the required client IDs and supply them to the backend using the proper API annotation attribute. Precisely which client IDs are required and how you need to supply them can vary depending on whether the client is an Android app, iOS app, or javascript app. For details, see [Specifying Authorized Clients in the API Backend](#Specifying_authorized_clients_in_the_API_backend).

### Creating an OAuth 2.0 web client ID

To create a web client ID:

1.  Make sure you are logged in to the Google account you used to create the Google Cloud Platform Console project.

2.  Open the [Credentials page](https://web.archive.org/web/20160424225802/https://console.cloud.google.com/project/_/apiui/credential/oauthclient) for your project, and select **Web application** as the application type.

3.  Fill out the form that is displayed:

    1.  Specify a name for the web client.

    2.  If you are [testing the backend locally](https://web.archive.org/web/20160424225802/https://cloud.google.com/appengine/docs/java/endpoints/test_deploy#running_and_testing_api_backends_locally), specify `http://localhost:8080` in the textbox labeled *Authorized JavaScript origins*. If you are deploying your backend API to production App Engine, specify the App Engine URL of your backend API in the textbox labeled *Authorized JavaScript origins*; for example, `https://your_project_id.appspot.com`, replacing `your_project_id` with your actual App Engine project ID.

        **Important:** You must specify the site or host name under *Authorized JavaScript origins* using `https` for this to work with Endpoints, unless you are testing with `localhost`, in which case you must use `http`.

4.  Click **Create**.

Note the client ID that is generated. This is the client ID you need to use in your backend and in your client application.

### Creating an OAuth 2.0 Android client ID

In order to create the OAuth 2.0 Android client ID, you'll need to have a certificate key fingerprint. If you use Eclipse with the Android Developer Tools (ADT) plugin, a debug keystore and a debug key are created automatically. You can use the debug key for testing purposes, but you must use a release key for production!

Note that the default debug keystore password is `android`, and the key alias is `androiddebugkey`. The default location for Linux and Mac OS X is `~/.android`.

**Warning:** When you create a release key, do not use `android` as your release key or keystore password.

1.  Generate a debug (or release) key for your Android application, if you don’t already have one. If you use Eclipse with the Android Developer Tools plugin, Eclipse automatically generates a debug key in the debug keystore the first time you build an Android project.

2.  In a Linux or Mac OS X terminal window, you can get the fingerprint of the key using the `keytool` (included with the Java SDK) as follows:

    ```
    keytool -exportcert -alias androiddebugkey -keystore path-to-debug-or-production-keystore -list -v
    ```

    The fingerprint looks something like this: `DA:39:A3:EE:5E:6B:4B:0D:32:55:BF:EF:95:60:18:90:AF:D8:07:09`

3.  Copy and save the key fingerprint that is displayed after your run the above `keytool` command. You'll need to supply this next to generate the Android client ID in the console.

4.  Open the [Credentials page](https://web.archive.org/web/20160424225802/https://console.cloud.google.com/project/_/apiui/credential/oauthclient) for your project and select **Android** as the application type.

5.  In the textbox labeled *Signing-certificate fingerprint*, enter the fingerprint you obtained above.

6.  In the textbox labeled *Package name* enter the Android application package name, as specified in your `AndroidManifest.xml` file.

7.  Click **Create**.

Note the client ID that is generated as you'll need to use it later in your client code. You can always revisit your project later in the console to locate this client ID.

### Creating an OAuth 2.0 iOS client ID

1.  Open the [Credentials page](https://web.archive.org/web/20160424225802/https://console.cloud.google.com/project/_/apiui/credential/oauthclient) for your project and select **iOS** as the application type.
2.  Specify a name for the client.
3.  In the textbox labeled *Bundle ID*, specify your application’s bundle identifier as listed in your application's `.plist` file (e.g. `com.example.myapp`).
4.  In the textbox labeled *App Store ID*, optionally enter the App Store ID if the app was published in the Apple iTunes® App Store.
5.  Click **Create**.

Note the client ID that is generated as you'll need to use it later in your client code. You can always revisit your project later in the console to locate this client ID.
